<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <script src="js/mui.min.js"></script>
    <script src="js/jquery-3.2.1.min.js"></script>
    <link href="css/mui.min.css" rel="stylesheet"/>
    <link href="css/moment_main.css" rel="stylesheet"/>
    <link href="css/main_page.css" rel="stylesheet"/>
   
    <style type="text/css">
    	#app_name .mui-icon .mui-icon-clear .mui-hidden{line-height: 3vh;}
    </style>
</head>
<body>

	<div id="main" class="sign_content mui-content">
		<!--  Top Templete  Start -->
	<header class="mui-bar mui-bar-nav" style="background: #FFFFFF;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title" style="font-size:1.5rem;">聊天中</h1>
 </header>
		<!--  Top Templete  End -->

		<!--  Near By Templete  -->
		<div style="padding-top: 30px;overflow:auto;">
		 
		<ul id="OA_task_1">
		
		</ul>
		</div>
		
		<textarea name="talk" id="talk">
			
		</textarea>
		<button id="stalk">发送</button>
		
		<!--  Bottom Templete Start  -->
		<div id="bottom_menu">
			<ul id="bottom_ul_menu">
				<li><img src="img/icon/home.png" onclick="window.location.href='main_page.html'"></li>
				<li><img src="img/icon/message.png" onclick="window.location.href='chat_list.html'"></li>
				<li><img src="img/icon/create.png"></li>
				<li><img src="img/icon/moment.png" onclick="window.location.href='moment.html'"></li>
				<li><img src="img/icon/user2.png" onclick="window.location.href='user_center.html'"></li>
			</ul>
		</div>
		<!--  Bottom Templete End  -->
	</div>
</body>
<script language="JavaScript">

	var uid = localStorage.getItem('user_id');
	var self = plus.webview.currentWebview();
    var fuid = self.fuid;
    var message_num=0;
    	mui.getJSON('http://whois8.cn/gettalking.php',{uid:uid,fuid:fuid},function(data){
		       //数据绑定在此处
	           var list = document.getElementById("OA_task_1");
	           var fragment = document.createDocumentFragment();
               var li;
		       mui.each(data,function(index,item){
           
                    li = document.createElement('li');
                    li.id=item[0];
                    //console.log(data5);
                    if(item[0]==uid){
                    	    li.innerHTML =   "我说："+item[2];

                    }else{
                    	    li.innerHTML =   "对方说："+item[2];
                    	    message_num=message_num+1;

                    }
                    fragment.appendChild(li);
                  
                })
		       list.appendChild(fragment);
 
	        });
	  
	document.getElementById('stalk').addEventListener('tap', function() {
	 
	 var content=document.getElementById('talk').value;
	 //console.log(content);
	 mui.post('http://whois8.cn/sendmessage.php',{
		uid:uid,
		fuid:fuid,
		content:content
	    },function(data){
	    
	        mui.alert(data);
            document.getElementById("OA_task_1").innerHTML+="<br/>我说:"+content;
	    
	     },'text'
       );
	 });
	 
	 //定时刷新消息
	 window.setInterval(function(){
	 	
	 	mui.post('http://whois8.cn/getnewmessage.php',{
		uid:fuid,
		fuid:uid,
		messagenum:message_num
	    },function(data){
	    
	    //console.log(data["num"]);
	     if(data['num']>0){
	    	message_num=parseInt(message_num)+parseInt(data["num"]);
	    	
	    	mui.each(data[0],function(index,item){
           
                   
                   //console.log(item[2]);
                   document.getElementById("OA_task_1").innerHTML+="<br/>对方说:"+item[2];
                  
               })
	     }
	        //mui.alert(data);
	     },'json'
       );
	 
	 
	 },5000);

</script>
</html>